<!DOCTYPE html>

<html lang="tr">

<head>

  <meta charset="UTF-8">

  <title>Santis Club Test Raporu</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #121212;
      color: #e0e0e0;
    }

    h1 {
      color: #64b5f6;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }

    .summary-box {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

    .card {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      min-width: 150px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .card h3 {
      margin: 0 0 5px;
      font-size: 2em;
    }

    .card span {
      color: #888;
      font-size: 0.9em;
      text-transform: uppercase;
    }

    .pass {
      color: #4caf50;
    }

    .fail {
      color: #f44336;
    }



    table {
      width: 100%;
      border-collapse: collapse;
      background: #1e1e1e;
      border-radius: 8px;
      overflow: hidden;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    th {
      background: #252525;
      color: #aaa;
      font-weight: 600;
    }

    tr:hover {
      background: #2a2a2a;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
    }

    .bg-pass {
      background: rgba(76, 175, 80, 0.2);
      color: #81c784;
    }

    .bg-fail {
      background: rgba(244, 67, 54, 0.2);
      color: #e57373;
    }

    .bg-warn {
      background: rgba(255, 152, 0, 0.2);
      color: #ffb74d;
    }



    .filter-bar {
      margin-bottom: 15px;
    }

    button {
      background: #333;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:hover {
      background: #444;
    }

    button.active {
      background: #64b5f6;
      color: #000;
    }
  </style>

</head>

<body>

  <h1>🛡️ Santis Club Sistem Sağlık Raporu</h1>



  <div class="summary-box">

    <div class="card">
      <h3 id="totalCount">-</h3><span>Toplam Test</span>
    </div>

    <div class="card">
      <h3 id="passCount" class="pass">-</h3><span>Başarılı</span>
    </div>

    <div class="card">
      <h3 id="failCount" class="fail">-</h3><span>Hatalı</span>
    </div>

  </div>



  <div class="filter-bar">

    <button data-filter="all" onclick="filter('all')">Tümü</button>

    <button data-filter="attention" onclick="filter('attention')" class="active">Hata & Uyarı</button>

    <button data-filter="fail" onclick="filter('fail')">Sadece Hatalar</button>

    <button data-filter="warn" onclick="filter('warn')">Sadece Uyarılar</button>

    <button data-filter="slow" onclick="filter('slow')">Yavaş Testler (>200ms)</button>

    <button onclick="downloadCSV()" style="float:right; background:#388e3c;">📥 CSV İndir</button>

    <button onclick="downloadJSON()" style="float:right; background:#0288d1; margin-right:10px;">📋 JSON İndir</button>

  </div>



  <table id="resultsTable">

    <thead>

      <tr>

        <th width="100">Durum</th>

        <th width="150">Kategori</th>

        <th width="100" style="text-align:right">Süre</th>

        <th>Detay</th>

        <th>Mesaj / URL</th>

      </tr>

    </thead>

    <tbody id="tableBody"></tbody>

  </table>



  <script>window.SANTIS_TEST_MANUAL_START = true;</script>

  <script src="test-runner-schema.js"></script>

  <script>

    const results = [];

    let currentFilter = 'attention'; // Varsayılan filtre: Sadece Hata ve Uyarılar

    const logger = {

      log: (msg, style) => processLog(msg, style, 'info'),

      error: (msg, style) => processLog(msg, style, 'fail'),

      warn: (msg, style) => processLog(msg, style, 'warn'),

      group: () => { }, groupEnd: () => { }

    };



    function processLog(msg, style, defaultType) {

      let type = defaultType;

      if (style && style.includes('#4caf50')) type = 'pass';

      else if (style && style.includes('#f44336')) type = 'fail';

      else if (style && style.includes('#ff9800')) type = 'warn';



      const cleanMsg = String(msg).replace('%c', '').trim();

      if (!cleanMsg) return;



      let category = 'Genel';

      if (cleanMsg.includes('JSON')) category = 'JSON Yapısı';

      else if (cleanMsg.includes('hotel.html')) category = 'Sayfa: Hotel';

      else if (cleanMsg.includes('service.html')) category = 'Sayfa: Service';

      else if (cleanMsg.includes('booking.html')) category = 'Sayfa: Booking';

      else if (cleanMsg.includes('Hotel[')) category = 'Veri: Hotel';



      let duration = 0;

      const timeMatch = cleanMsg.match(/\[(\d+)ms\]/);

      if (timeMatch) duration = parseInt(timeMatch[1]);



      results.push({ type, category, msg: cleanMsg, duration });

      renderRow(type, category, cleanMsg);

      updateStats();

      updateEmptyState();

    }



    function renderRow(type, cat, msg) {

      const tbody = document.getElementById('tableBody');

      const tr = document.createElement('tr');

      tr.className = `row-${type}`;

      let badgeClass = 'bg-warn', badgeText = 'BİLGİ';

      if (type === 'pass') { badgeClass = 'bg-pass'; badgeText = 'BAŞARILI'; }

      if (type === 'fail') { badgeClass = 'bg-fail'; badgeText = 'HATALI'; }



      let duration = '-';

      let durationStyle = 'color:#888;';



      const timeMatch = msg.match(/\[(\d+)ms\]/);

      if (timeMatch) {

        const ms = parseInt(timeMatch[1]);

        duration = ms + 'ms';

        if (ms > 200) {

          durationStyle = 'color:#ffeb3b; font-weight:bold;';

          tr.classList.add('row-slow');

        }

      }



      // Filtreleme mantığını satır oluşturulurken uygula

      let show = false;

      if (currentFilter === 'all') show = true;

      else if (currentFilter === 'attention') show = (type === 'fail' || type === 'warn');

      else if (currentFilter === 'slow') show = tr.classList.contains('row-slow');

      else show = (type === currentFilter);

      if (!show) tr.style.display = 'none';



      tr.innerHTML = `

        <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>

        <td>${cat}</td>

        <td style="text-align:right; font-family:monospace; ${durationStyle}">${duration}</td>

        <td>${msg.split(' - ')[0]}</td>

        <td style="font-family:monospace; font-size:0.9em; color:#aaa;">${msg}</td>

      `;

      tbody.appendChild(tr);

    }



    function updateStats() {

      document.getElementById('totalCount').textContent = results.length;

      document.getElementById('passCount').textContent = results.filter(r => r.type === 'pass').length;

      document.getElementById('failCount').textContent = results.filter(r => r.type === 'fail').length;



      // Buton metinlerini güncelle

      const counts = {

        all: results.length,

        attention: results.filter(r => r.type === 'fail' || r.type === 'warn').length,

        fail: results.filter(r => r.type === 'fail').length,

        warn: results.filter(r => r.type === 'warn').length,

        slow: results.filter(r => r.duration > 200).length

      };



      const labels = { all: "Tümü", attention: "Hata & Uyarı", fail: "Sadece Hatalar", warn: "Sadece Uyarılar", slow: "Yavaş Testler (>200ms)" };



      for (const [key, count] of Object.entries(counts)) {

        const btn = document.querySelector(`button[data-filter="${key}"]`);

        if (btn) btn.textContent = `${labels[key]} (${count})`;

      }

    }



    function filter(type) {

      currentFilter = type;

      document.querySelectorAll('tbody tr').forEach(row => {

        if (row.id === 'emptyFailState') return; // Bilgi mesajını gizleme

        let show = false;

        if (type === 'all') show = true;

        else if (type === 'attention') show = row.classList.contains('row-fail') || row.classList.contains('row-warn');

        else show = row.classList.contains(`row-${type}`);

        row.style.display = show ? '' : 'none';

      });

      document.querySelectorAll('.filter-bar button').forEach(btn => {

        btn.classList.toggle('active', btn.dataset.filter === type);

      });

      updateEmptyState();

    }



    function updateEmptyState() {

      const tbody = document.getElementById('tableBody');

      if (!tbody) return;

      const markerId = 'emptyFailState';

      let markerRow = document.getElementById(markerId);



      // Mevcut filtreye göre görünür satır var mı kontrol et

      let hasVisible = false;

      if (currentFilter === 'all') hasVisible = results.length > 0;

      else if (currentFilter === 'attention') hasVisible = results.some(r => r.type === 'fail' || r.type === 'warn');

      else if (currentFilter === 'slow') hasVisible = results.some(r => r.duration > 200);

      else hasVisible = results.some(r => r.type === currentFilter);



      if (hasVisible) {

        if (markerRow) markerRow.remove();

        return;

      }



      // Mesaj gösterilecek durumlar

      let message = "";

      if (['attention', 'fail', 'warn'].includes(currentFilter)) message = "🎉 Harika! Hiçbir sorun bulunamadı.";

      else if (currentFilter === 'slow') message = "⚡ Harika! Yavaş test bulunamadı.";



      if (!message) {

        if (markerRow) markerRow.remove();

        return;

      }



      if (!markerRow) {

        markerRow = document.createElement('tr');

        markerRow.id = markerId;

        tbody.appendChild(markerRow);

      }



      markerRow.innerHTML = `

        <td colspan="5" style="text-align:center; color:#4caf50; padding:30px 10px; font-size:1.1em;">

          ${message}

        </td>

      `;

    }



    function downloadCSV() {

      if (!results.length) return alert("İndirilecek veri yok.");



      const headers = ["DURUM", "KATEGORI", "SURE", "MESAJ"];

      const csvRows = [headers.join(",")];



      results.forEach(r => {

        let duration = '';

        const timeMatch = r.msg.match(/\[(\d+)ms\]/);

        if (timeMatch) duration = timeMatch[1] + 'ms';



        const msg = `"${r.msg.replace(/"/g, '""')}"`;

        csvRows.push([r.type.toUpperCase(), r.category, duration, msg].join(","));

      });



      const csvString = "\uFEFF" + csvRows.join("\n");

      const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });

      const link = document.createElement("a");

      link.href = URL.createObjectURL(blob);

      link.download = `santis_report_${new Date().toISOString().slice(0, 10)}.csv`;

      link.click();

    }



    function downloadJSON() {

      if (!results.length) return alert("İndirilecek veri yok.");



      const jsonString = JSON.stringify(results, null, 2);

      const blob = new Blob([jsonString], { type: "application/json;charset=utf-8;" });

      const link = document.createElement("a");

      link.href = URL.createObjectURL(blob);

      link.download = `santis_report_${new Date().toISOString().slice(0, 10)}.json`;

      link.click();

    }



    // 🚀 TESTLERİ BAŞLAT

    // Sayfa yüklendiğinde tanımladığımız 'logger' ile testleri çalıştırıyoruz.

    window.addEventListener('DOMContentLoaded', () => {

      if (window.runSantisTests) {

        window.runSantisTests(logger).catch(err => {

          logger.error("Test başlatılamadı: " + err.message);

        });

      } else {

        logger.error("test-runner-schema.js yüklenemedi!");

      }

    });

  </script>

</body>

</html>